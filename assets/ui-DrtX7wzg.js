import{r as _,j as t,R as $}from"./app-CuDb7JLo.js";import{a as S}from"./game-Dc_pgXx_.js";import{t as i,f as C,U as M,B as Y,b as D,C as P,e as V,i as U,l as I}from"./constants-5vHi3EcM.js";const re=({gameState:r,building:e,x:s,y:o,visible:u,onHide:h})=>{const x=_.useRef(null),[d,l]=_.useState({x:0,y:0});if(_.useEffect(()=>{if(!u||!x.current)return;const g=x.current.getBoundingClientRect();let y=s+15,m=o-g.height/2;y+g.width>window.innerWidth&&(y=s-g.width-15),m<10&&(m=10),m+g.height>window.innerHeight-10&&(m=window.innerHeight-g.height-10),l({x:y,y:m})},[u,s,o]),!u||!e)return null;const n=r.buildings[e.id]||i(0),f=F(r,e),v=f.times(n),c=K(r),b=c.gt(0)?v.div(c).times(100):i(0),j=Q(e.baseCost,n),T=j.gt(0)?f.div(j):i(0),a=T.gt(0)?j.div(f):i(0);return t.jsxs("div",{ref:x,className:"advanced-tooltip",style:{position:"fixed",left:`${d.x}px`,top:`${d.y}px`,background:"var(--panel-bg)",color:"var(--text-color)",padding:"12px",borderRadius:"2px",border:"4px double var(--accent-color)",fontSize:"13px",lineHeight:"1.4",width:"280px",minWidth:"280px",zIndex:1e4,boxShadow:"var(--shadow)",pointerEvents:"none",transition:"all 0.15s ease"},onMouseLeave:h,children:[t.jsxs("div",{style:{fontWeight:"bold",fontSize:"16px",marginBottom:"8px",color:"var(--accent-color)",display:"flex",alignItems:"center",gap:"8px"},children:[t.jsx("span",{style:{fontSize:"18px"},children:e.icon}),t.jsx("span",{children:e.name})]}),t.jsxs("div",{style:{marginBottom:"8px",padding:"4px",background:"rgba(33, 150, 243, 0.1)",borderRadius:"4px",border:"1px solid rgba(33, 150, 243, 0.3)"},children:[t.jsxs("div",{style:{color:"rgba(33, 150, 243, 0.9)",fontWeight:"bold",fontSize:"13px"},children:["Count: ",C(n,r.numberFormat)]}),t.jsxs("div",{style:{fontSize:"12px",color:"var(--text-secondary)"},children:["Each: ",t.jsxs("span",{style:{color:"var(--success-color)"},children:[C(f,r.numberFormat),"/s"]})]}),t.jsxs("div",{style:{fontSize:"12px",color:"var(--text-secondary)"},children:["Total: ",t.jsxs("span",{style:{color:"var(--success-color)",fontWeight:"bold"},children:[C(v,r.numberFormat),"/s"]})]})]}),t.jsx("div",{style:{marginBottom:"8px",padding:"4px",background:"rgba(76, 175, 80, 0.1)",borderRadius:"4px",border:"1px solid var(--success-color)"},children:t.jsxs("div",{style:{fontWeight:"bold",color:"var(--success-color)",fontSize:"12px"},children:["ðŸ“Š ",C(b,r.numberFormat),"% of total income"]})}),t.jsxs("div",{style:{marginBottom:"6px",padding:"4px",background:"rgba(141, 110, 99, 0.1)",borderRadius:"4px",border:"1px solid var(--accent-color)"},children:[t.jsx("div",{style:{fontWeight:"bold",color:"var(--accent-color)",fontSize:"12px",marginBottom:"2px"},children:"ðŸ’° Economy"}),t.jsxs("div",{style:{fontSize:"11px",color:"var(--text-secondary)"},children:["Next: ",t.jsxs("span",{style:{color:"var(--accent-color)"},children:[C(j,r.numberFormat)," gold"]})]}),t.jsxs("div",{style:{fontSize:"11px",color:"var(--text-secondary)"},children:["Payoff: ",t.jsx("span",{style:{color:"#ff9800"},children:Z(a)})]}),t.jsxs("div",{style:{fontSize:"11px",color:"var(--text-secondary)"},children:["Efficiency: ",t.jsxs("span",{style:{color:"var(--success-color)"},children:[C(T.times(100),r.numberFormat)," gold/s per gold"]})]})]}),t.jsx("div",{style:{fontSize:"11px",color:"var(--text-secondary)",fontStyle:"italic",marginTop:"8px",borderTop:"1px solid var(--border-color)",paddingTop:"6px"},children:e.description})]})};function F(r,e){var v;let s=e.baseProduction;const o=((v=r.weather)==null?void 0:v.current)||"clear";o==="sunny"&&(e.id==="peasant"||e.id==="field")?s=s.times(i(1.2)):o==="rainy"&&(e.id==="silver_mine"||e.id==="alchemist")?s=s.times(i(1.2)):o==="stormy"?(e.id==="blacksmith"&&(s=s.times(i(1.3))),e.id==="field"&&(s=s.times(i(.8)))):o==="windy"&&e.id==="market"&&(s=s.times(i(1.15)));const u=M.filter(c=>c.type==="building"&&c.targetId===e.id&&r.upgrades.includes(c.id));let h=i(1);u.forEach(c=>{h=h.times(c.multiplier||i(2))}),s=s.times(h);const x=M.filter(c=>c.type==="global"&&r.upgrades.includes(c.id));let d=i(1);x.forEach(c=>{d=d.times(c.multiplier||i(2))}),s=s.times(d);const l=X(r.renown);s=s.times(l);const n=J(r.artifacts);s=s.times(n);let f=i(1);return(r.activeDecrees.royal_feast||i(0)).gt(i(Date.now()))&&(f=f.times(i(2))),(r.activeDecrees.call_to_arms||i(0)).gt(i(Date.now()))&&(f=f.times(i(5))),s=s.times(f),s}function X(r){const e=r.toNumber();if(e<=0)return i(1);let s=i(1);e<=100?s=i(1+e*.01):e<=1e3?s=i(2).plus(i(e-100).times(i(.005))):e<=1e4?s=i(2.5).plus(i(e-1e3).times(i(.001))):s=i(10).plus(i(10).times(Math.log10(e)));const o=i(1e3);return S.min(s,o)}function J(r){let e=i(1);return r.includes("ancient_crown")&&(e=e.times(i(1.5))),r.includes("blessed_chalice")&&(e=e.times(i(1.25))),r.includes("dragon_scale")&&(e=e.times(i(1.35))),r.includes("ancient_tablet")&&(e=e.times(i(1.5))),e}function K(r){let e=i(0);return Y.forEach(s=>{const o=r.buildings[s.id]||i(0);if(o.gt(0)){const u=F(r,s);e=e.plus(u.times(o))}}),e}function Q(r,e){return r.times(i(1.15).pow(e)).floor()}function Z(r){if(r.lte(0))return"Instant";const e=r.toNumber(),s=Math.floor(e/31536e3),o=Math.floor(e%31536e3/86400),u=Math.floor(e%86400/3600),h=Math.floor(e%3600/60),x=Math.floor(e%60),d=[];return s>0&&d.push(`${s}y`),o>0&&d.push(`${o}d`),u>0&&d.push(`${u}h`),h>0&&d.push(`${h}m`),(x>0||d.length===0)&&d.push(`${x}s`),d.length>4?d.slice(0,4).join(" "):d.join(" ")}const se=({gameState:r})=>{var d;const[e,s]=_.useState("all"),o=()=>{const l=D.sort((n,f)=>{const v=r.achievements.includes(n.id),c=r.achievements.includes(f.id);return v&&!c?-1:!v&&c?1:0});return e==="all"?l:l.filter(n=>e==="buildings"?n.id.startsWith("build_"):e==="clicks"?n.id.startsWith("clicks_"):e==="gold"?n.id.startsWith("gold_"):e==="soldiers"?n.id.startsWith("soldiers_"):e==="renown"?n.id.startsWith("renown_"):e==="dragons"?n.id.startsWith("dragons_"):e==="gambler"?n.id.startsWith("gambler_"):e==="total_builds"?n.id.startsWith("total_builds"):e==="efficiency"?["speed_1m","speed_1b","prestige_master"].includes(n.id):e==="wonders"?["first_wonder","complete_wonder","all_wonders"].includes(n.id):e==="artifacts"?["all_artifacts","first_artifact","half_artifacts"].includes(n.id):e==="advisors"?["first_advisor","all_advisors","advisor_upgrade"].includes(n.id):e==="trade"?["first_trade","trade_master"].includes(n.id):e==="secret"?["click_master","idle_master"].includes(n.id):e==="bonus"?["gold_veteran","production_master","speed_baker","prestige_novice","golden_touch","combo_master"].includes(n.id):e==="combo"?["building_soldier_combo","advisor_artifact_combo"].includes(n.id):!0)},u=[{id:"all",name:"All",icon:"ðŸ†"},{id:"buildings",name:"Buildings",icon:"ðŸ—ï¸"},{id:"clicks",name:"Clicks",icon:"ðŸ‘†"},{id:"gold",name:"Gold",icon:"ðŸ’°"},{id:"soldiers",name:"Army",icon:"âš”ï¸"},{id:"renown",name:"Prestige",icon:"ðŸ‘‘"},{id:"dragons",name:"Dragons",icon:"ðŸ‰"},{id:"gambler",name:"Tavern",icon:"ðŸŽ²"},{id:"total_builds",name:"Total Buildings",icon:"ðŸ›ï¸"},{id:"efficiency",name:"Efficiency",icon:"âš¡"},{id:"wonders",name:"Wonders",icon:"ðŸŒŸ"},{id:"artifacts",name:"Artifacts",icon:"ðŸ…"},{id:"advisors",name:"Advisors",icon:"ðŸ¤´"},{id:"trade",name:"Trade",icon:"ðŸš¢"},{id:"secret",name:"Secret",icon:"ðŸ”"},{id:"bonus",name:"Bonus",icon:"âœ¨"},{id:"combo",name:"Combo",icon:"âš¡"}],h={display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(60px, 1fr))",gap:"10px",padding:"10px",background:"var(--panel-bg)",border:"1px solid var(--border-color)",borderRadius:"4px",marginTop:"10px"},x=l=>({width:"100%",aspectRatio:"1",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",border:`2px solid ${l?"var(--gold-color)":"#ccc"}`,background:l?"#fff8e1":"#eee",borderRadius:"4px",opacity:l?1:.3,cursor:l?"help":"default",position:"relative"});return t.jsxs("div",{style:{marginTop:"auto",padding:"10px"},children:[t.jsx("h3",{style:{fontSize:"1rem",margin:"0 0 5px 0"},children:"Royal Decree (Achievements)"}),t.jsxs("div",{style:{fontSize:"0.8rem",color:"var(--text-secondary)",marginBottom:"10px",textAlign:"center"},children:[r.achievements.length," / ",D.length," Unlocked",e!=="all"&&t.jsxs("span",{children:[" | ",o().filter(l=>r.achievements.includes(l.id)).length," / ",o().length," in ",(d=u.find(l=>l.id===e))==null?void 0:d.name]})]}),t.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"5px",marginBottom:"10px",padding:"5px",background:"var(--panel-bg)",border:"1px solid var(--border-color)",borderRadius:"4px"},children:u.map(l=>t.jsxs("button",{onClick:()=>s(l.id),style:{padding:"4px 8px",fontSize:"0.75rem",border:`1px solid ${e===l.id?"var(--gold-color)":"var(--border-color)"}`,borderRadius:"3px",background:e===l.id?"#fff8e1":"var(--panel-bg)",cursor:"pointer",transition:"all 0.2s"},title:l.name,children:[t.jsx("span",{style:{marginRight:"2px"},children:l.icon}),t.jsx("span",{style:{display:e===l.id?"inline":"none"},children:l.name})]},l.id))}),t.jsx("div",{style:h,children:o().map(l=>{const n=r.achievements.includes(l.id);return t.jsx("div",{style:x(n),"data-tooltip":n?`${l.name}: ${l.description}`:"Locked",children:t.jsx("div",{style:{fontSize:"1.5rem",filter:n?"none":"grayscale(100%)",opacity:n?1:.2},children:n?l.icon:"â“"})},l.id)})})]})},oe=({gameState:r,onStartCrusade:e,onClose:s})=>{var T;const o=r.conquest.active?P.find(a=>a.id===r.conquest.crusadeId):null,u=r.advisors.includes("warmaster"),h=r.advisorLevels.warmaster||i(0),x=r.advisors.includes("warmaster")?h.toNumber()*.1:0;let d=1-x;r.weather.current==="windy"&&(d=d*.8);const[l,n]=_.useState(0),[f,v]=_.useState(0),c=o&&r.conquest.startTime&&r.conquest.active,b=c&&r.conquest.startTime?i(Date.now()-i(r.conquest.startTime).toNumber()).dividedBy(i(1e3)).gte(i(o.duration).times(i(d))):!1;console.log("Conquest Debug:",{conquestActive:r.conquest.active,crusadeId:r.conquest.crusadeId,startTime:(T=r.conquest.startTime)==null?void 0:T.toNumber(),activeCrusade:o==null?void 0:o.name,isCrusadeActuallyActive:c,isCrusadeExpired:b,speedMult:d,currentTime:Date.now(),elapsed:r.conquest.startTime?(Date.now()-r.conquest.startTime.toNumber())/1e3:"N/A"});const j=$.useRef(s);return $.useEffect(()=>{j.current=s},[s]),_.useEffect(()=>{if(console.log("Timer useEffect:",{isCrusadeActuallyActive:c,isCrusadeExpired:b}),c&&!b){console.log("Setting up interval for:",o==null?void 0:o.name);const a=setInterval(()=>{const p=Date.now(),g=i(r.conquest.startTime).toNumber(),y=i(p-g).dividedBy(i(1e3)),m=i(o.duration).times(i(d)),N=i(100).min(y.dividedBy(m).times(i(100)));n(N.toNumber());const R=S.max(i(0),m.minus(y)).ceil();v(R.toNumber()),console.log("Timer update:",{elapsed:y.toNumber(),duration:m.toNumber(),progress:N.toNumber(),remaining:R.toNumber()}),R.lte(0)&&N.gte(100)&&j.current()},1e3);return()=>clearInterval(a)}else n(0),v(0),console.log("Timer reset - no active crusade")},[c,b,o,r.conquest.startTime,d]),t.jsx("div",{className:"modal-overlay",children:t.jsxs("div",{className:"modal-content",style:{maxWidth:"600px"},children:[t.jsx("h2",{children:"War Room"}),t.jsxs("div",{className:"modal-body",style:{maxHeight:"60dvh",overflowY:"auto",WebkitOverflowScrolling:"touch",touchAction:"pan-y"},children:[t.jsxs("div",{style:{marginBottom:"20px",display:"flex",gap:"10px",justifyContent:"center",flexWrap:"wrap"},children:[r.artifacts.map(a=>{const p=V.find(g=>g.id===a);return t.jsx("div",{"data-tooltip":p==null?void 0:p.description,style:{fontSize:"2rem",width:"3.5rem",height:"3.5rem",display:"flex",justifyContent:"center",alignItems:"center",border:"2px solid gold",borderRadius:"50%",background:"rgba(255, 215, 0, 0.1)",flexShrink:0},children:p==null?void 0:p.icon},a)}),r.artifacts.length===0&&t.jsx("span",{style:{color:"var(--text-secondary)"},children:"No artifacts claimed yet."})]}),c&&!b?t.jsxs("div",{style:{textAlign:"center"},children:[t.jsxs("h3",{children:["Current Crusade: ",o.name]}),t.jsx("div",{style:{width:"100%",height:"20px",background:"#ccc",borderRadius:"10px",overflow:"hidden",margin:"20px 0"},children:t.jsx("div",{style:{width:`${l}%`,height:"100%",background:"var(--accent-color)",transition:"width 1s linear"}})}),u&&t.jsx("div",{style:{color:"var(--success-color)",fontSize:"0.8rem",marginBottom:"5px"},children:"Warmaster Active (Faster & Safer)"}),t.jsxs("div",{children:["Time remaining: ",f,"s"]})]}):t.jsx("div",{style:{textAlign:"center",padding:"20px"},children:t.jsx("div",{style:{color:"var(--text-secondary)",marginBottom:"20px"},children:r.conquest.active?"Previous crusade has completed.":"No active crusades at the moment."})}),(!c||b)&&t.jsx("div",{style:{maxHeight:"300px",overflowY:"auto"},children:P.map(a=>{var q;const p=r.artifacts.includes(a.rewardArtifactId);let g=r.soldiers.gte(i(a.soldierCost)),y=[];if(a.requiredUnits){for(const[w,B]of Object.entries(a.requiredUnits))if((r.eliteUnits[w]||i(0)).lt(B)){g=!1;const W=((q=U.find(A=>A.id===w))==null?void 0:q.name)||w;y.push(`${B} ${W}`)}}const m=i(a.duration).times(i(d)),N=a.baseRisk||i(0),R=x*2,k=N.minus(i(R)),H=i(1).minus(k).times(i(100)).floor();let z="var(--success-color)";k.gt(i(.1))&&(z="orange"),k.gt(i(.3))&&(z="var(--danger-color)");const G=p?"#f0f4c3":"transparent",L=p?"gold":"var(--border-color)";return t.jsxs("div",{style:{border:`1px solid ${L}`,background:G,padding:"10px",marginBottom:"10px",borderRadius:"4px",textAlign:"left",position:"relative"},children:[p&&t.jsx("div",{style:{position:"absolute",top:5,right:5,fontSize:"1.2rem"},children:"ðŸ†"}),t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",paddingRight:"30px"},children:[t.jsxs("strong",{children:[a.icon," ",a.name]}),t.jsxs("span",{children:[m.gte(i(3600))?`${Math.floor(m.toNumber()/3600)}h `:"",Math.floor(m.toNumber()%3600/60),"m",m.toNumber()%60>0&&` ${Math.floor(m.toNumber()%60)}s`]})]}),t.jsx("div",{style:{fontSize:"0.9rem",color:"var(--text-secondary)"},children:a.description}),t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"10px",fontSize:"0.85rem"},children:[t.jsxs("div",{children:["Cost: ",t.jsxs("strong",{children:[C(a.soldierCost,r.numberFormat)," Soldiers"]})]}),t.jsxs("div",{style:{color:z,fontWeight:"bold"},children:["Success Chance: ",H.toString(),"%"]})]}),a.requiredUnits&&t.jsxs("div",{style:{fontSize:"0.8rem",marginTop:"5px",color:y.length>0?"var(--danger-color)":"var(--success-color)"},children:["Requires: ",Object.entries(a.requiredUnits).map(([w,B])=>{var A;const E=((A=U.find(O=>O.id===w))==null?void 0:A.name)||w,W=r.eliteUnits[w]||i(0);return`${E} (${W.toString()}/${B.toString()}) `})]}),k.gt(i(0))&&t.jsx("div",{style:{fontSize:"0.75rem",color:"var(--text-secondary)",marginTop:"2px"},children:"Failure refunds 50% soldiers."}),t.jsx("button",{className:"btn",style:{width:"100%",marginTop:"5px",background:p?"#827717":"var(--accent-color)"},disabled:!g,onClick:()=>e(a.id),children:p?"Replay Mission (Critical Chance)":"Start Campaign"})]},a.id)})})]}),t.jsx("button",{className:"btn",onClick:s,style:{marginTop:"20px"},children:"Close"})]})})},ne=({onClose:r})=>t.jsx("div",{className:"modal-overlay",children:t.jsxs("div",{className:"modal-content",style:{maxWidth:"600px",maxHeight:"80vh",display:"flex",flexDirection:"column"},children:[t.jsx("h2",{children:"ðŸ“œ Royal Chronicles"}),t.jsx("div",{style:{overflowY:"auto",textAlign:"left",padding:"0 20px",flex:1},children:I.map((e,s)=>t.jsxs("div",{style:{marginBottom:"20px",borderBottom:s<I.length-1?"1px dashed #ccc":"none",paddingBottom:"10px"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"5px"},children:[t.jsxs("span",{style:{fontSize:"1.2rem",fontWeight:"bold",color:"var(--accent-color)"},children:["v",e.version]}),t.jsx("span",{style:{fontSize:"0.8rem",color:"var(--text-secondary)"},children:e.date})]}),t.jsx("ul",{style:{margin:"5px 0",paddingLeft:"20px"},children:e.changes.map((o,u)=>t.jsx("li",{style:{marginBottom:"3px"},children:o},u))})]},e.version))}),t.jsx("button",{className:"btn",style:{marginTop:"20px",alignSelf:"center"},onClick:r,children:"Close Chronicles"})]})});export{se as A,oe as C,ne as a,re as b,X as g};
